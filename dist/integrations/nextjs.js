"use strict";var e=require("fs"),t=require("path");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(s){if("default"!==s){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return e[s]}})}}),t.default=e,Object.freeze(t)}var LogLevel,LogStrategy,i=s(e),n=s(t);!function(LogLevel){LogLevel[LogLevel.DEBUG=0]="DEBUG",LogLevel[LogLevel.INFO=1]="INFO",LogLevel[LogLevel.WARN=2]="WARN",LogLevel[LogLevel.ERROR=3]="ERROR",LogLevel[LogLevel.FATAL=4]="FATAL"}(LogLevel||(LogLevel={})),function(LogStrategy){LogStrategy.CONSOLE="console",LogStrategy.MEMORY="memory",LogStrategy.DATABASE="database",LogStrategy.FILE="file",LogStrategy.HYBRID="hybrid"}(LogStrategy||(LogStrategy={}));const a={strategy:"production"===process.env.NODE_ENV?LogStrategy.HYBRID:LogStrategy.CONSOLE,level:"production"===process.env.NODE_ENV?LogLevel.WARN:LogLevel.DEBUG,maxMemoryEntries:parseInt(process.env.LOG_MAX_MEMORY_ENTRIES||"1000"),maxDatabaseEntries:parseInt(process.env.LOG_MAX_DATABASE_ENTRIES||"10000"),maxFileEntries:parseInt(process.env.LOG_MAX_FILE_ENTRIES||"5000"),enableConsole:"production"!==process.env.NODE_ENV,enableDatabase:!0,enableFile:"production"===process.env.NODE_ENV,databaseTable:"error_logs",filePath:process.env.LOG_FILE_PATH||"./logs/app.log",maxFileSize:parseInt(process.env.LOG_MAX_FILE_SIZE||"10485760"),maxFiles:parseInt(process.env.LOG_MAX_FILES||"5"),format:"production"===process.env.NODE_ENV?"json":"pretty",includeStack:!0,includeMetadata:!0};class r{constructor(){this.name="console",this.config={}}configure(e){this.config=e}async log(e){if(!this.config.enableConsole)return;const t=e.timestamp.toISOString(),s=LogLevel[e.level],i=e.context?` ${JSON.stringify(e.context)}`:"",n=e.metadata?` ${JSON.stringify(e.metadata)}`:"";let a=`[${t}] ${s}: ${e.message}${i}${n}`;switch(e.error&&this.config.includeStack&&(a+=`\nError: ${e.error.message}`,e.stack&&(a+=`\nStack: ${e.stack}`)),e.level){case LogLevel.DEBUG:case LogLevel.INFO:case LogLevel.WARN:case LogLevel.ERROR:case LogLevel.FATAL:}}}class o{constructor(){this.name="memory",this.config={},this.logs=[]}configure(e){this.config=e}async log(e){this.logs.push(e);const t=this.config.maxMemoryEntries||1e3;this.logs.length>t&&(this.logs=this.logs.slice(-t))}getLogs(e){const t=this.logs.slice();return e?t.slice(-e):t}getErrorLogs(e){const t=this.logs.filter(e=>e.level>=LogLevel.ERROR);return e?t.slice(-e):t}clear(){this.logs=[]}getStats(){const e=this.logs.filter(e=>e.level>=LogLevel.ERROR).length;return{count:this.logs.length,errors:e,maxEntries:this.config.maxMemoryEntries||1e3}}}class l{constructor(){this.name="database",this.config={},this.logs=[]}configure(e){this.config=e}async log(e){if(this.config.enableDatabase&&!(e.level<LogLevel.ERROR))try{this.logs.push(e);const t=this.config.maxDatabaseEntries||1e4;this.logs.length>t&&(this.logs=this.logs.slice(-t))}catch(e){}}async query(e={}){let t=this.logs.slice();return void 0!==e.level&&(t=t.filter(t=>t.level>=e.level)),e.startDate&&(t=t.filter(t=>t.timestamp>=e.startDate)),e.endDate&&(t=t.filter(t=>t.timestamp<=e.endDate)),e.userId&&(t=t.filter(t=>t.userId===e.userId)),e.appSlug&&(t=t.filter(t=>t.appSlug===e.appSlug)),e.offset&&(t=t.slice(e.offset)),e.limit&&(t=t.slice(0,e.limit)),t}async clear(){this.logs=[]}getStats(){const e=this.logs.filter(e=>e.level>=LogLevel.ERROR).length;return{count:this.logs.length,errors:e,maxEntries:this.config.maxDatabaseEntries||1e4}}}class c{constructor(){this.name="file",this.config={},this.fileConfig={},this.logs=[],this.filePath="",this.currentFileSize=0}configure(e){this.config={enableFile:e.enableFile||!1,...e},this.fileConfig={filePath:e.filePath||"./logs/app.log",directory:e.directory||"./logs",fileName:e.fileName||"app.log",maxFileSize:e.maxFileSize||10485760,maxFiles:e.maxFiles||5,enableRotation:void 0===e.enableRotation||e.enableRotation,enableCompression:e.enableCompression||!1,logLevels:e.logLevels||[LogLevel.ERROR,LogLevel.FATAL],includeTimestamp:void 0===e.includeTimestamp||e.includeTimestamp,includeLevel:void 0===e.includeLevel||e.includeLevel,format:e.format||"json",overwrite:e.overwrite||!1,append:void 0===e.append||e.append},this.setupFilePath(),this.ensureDirectoryExists()}setupFilePath(){this.fileConfig.filePath?this.filePath=this.fileConfig.filePath:this.fileConfig.directory&&this.fileConfig.fileName?this.filePath=n.join(this.fileConfig.directory,this.fileConfig.fileName):this.filePath="./logs/app.log"}ensureDirectoryExists(){const e=n.dirname(this.filePath);i.existsSync(e)||i.mkdirSync(e,{recursive:!0})}async log(e){if(this.config.enableFile&&(!this.fileConfig.logLevels||this.fileConfig.logLevels.includes(e.level)))try{this.logs.push(e);const t=this.config.maxFileEntries||5e3;this.logs.length>t&&(this.logs=this.logs.slice(-t)),await this.writeToFile(e),this.fileConfig.enableRotation&&await this.rotateIfNeeded()}catch(e){}}async writeToFile(e){const t=this.formatLogEntry(e),s=i.existsSync(this.filePath);this.fileConfig.overwrite&&!s?(i.writeFileSync(this.filePath,t+"\n"),this.currentFileSize=t.length+1):this.fileConfig.append||s?(i.appendFileSync(this.filePath,t+"\n"),this.currentFileSize+=t.length+1):(i.writeFileSync(this.filePath,t+"\n"),this.currentFileSize=t.length+1)}formatLogEntry(e){const t={};!1!==this.fileConfig.includeTimestamp&&(t.timestamp=e.timestamp.toISOString()),!1!==this.fileConfig.includeLevel&&(t.level=LogLevel[e.level]),t.message=e.message,e.context&&(t.context=e.context),e.metadata&&(t.metadata=e.metadata),e.userId&&(t.userId=e.userId),e.requestId&&(t.requestId=e.requestId),e.appSlug&&(t.appSlug=e.appSlug),e.error&&(t.error=e.error.message),e.stack&&(t.stack=e.stack);const s=this.fileConfig.format||"json";if("json"===s)return JSON.stringify(t);if("pretty"===s)return JSON.stringify(t,null,2);{const s=!1!==this.fileConfig.includeTimestamp?`[${t.timestamp}] `:"",i=!1!==this.fileConfig.includeLevel?`${t.level} `:"",n=e.context?` ${JSON.stringify(e.context)}`:"",a=e.metadata?` ${JSON.stringify(e.metadata)}`:"";return`${s}${i}${t.message}${n}${a}`}}async rotateIfNeeded(){try{const e=i.statSync(this.filePath),t=this.fileConfig.maxFileSize||10485760;e.size>t&&await this.rotateFile()}catch(e){}}async rotateFile(){const e=this.fileConfig.maxFiles||5,t=this.filePath.replace(".log","");for(let s=e-1;s>0;s--){const n=`${t}.${s}.log`,a=`${t}.${s+1}.log`;i.existsSync(n)&&(s===e-1?i.unlinkSync(n):i.renameSync(n,a))}i.existsSync(this.filePath)&&(i.renameSync(this.filePath,`${t}.1.log`),this.currentFileSize=0)}getStats(){const e=this.logs.filter(e=>e.level>=LogLevel.ERROR).length;return{count:this.logs.length,errors:e,maxEntries:this.config.maxFileEntries||5e3,filePath:this.filePath}}async cleanup(){}}function g(e){const t=Math.random().toString(36).substring(2,10);return e?`${e}-${t}`:t}class LoggerService{constructor(e={}){this.adapters=new Map,this.config=function(e={}){return{...a,...e}}(e);const t=function(e){const t=[];return e.maxMemoryEntries&&e.maxMemoryEntries<1&&t.push("maxMemoryEntries must be greater than 0"),e.maxDatabaseEntries&&e.maxDatabaseEntries<1&&t.push("maxDatabaseEntries must be greater than 0"),e.maxFileEntries&&e.maxFileEntries<1&&t.push("maxFileEntries must be greater than 0"),e.maxFileSize&&e.maxFileSize<1024&&t.push("maxFileSize must be at least 1KB"),e.maxFiles&&e.maxFiles<1&&t.push("maxFiles must be greater than 0"),e.filePath&&!e.filePath.endsWith(".log")&&t.push("filePath should end with .log extension"),t}(this.config);if(t.length>0)throw new Error(`Invalid logger configuration: ${t.join(", ")}`);this.initializeAdapters()}static getInstance(e){return LoggerService.instance||(LoggerService.instance=new LoggerService(e)),LoggerService.instance}static create(e={}){return new LoggerService(e)}static reset(){LoggerService.instance&&(LoggerService.instance.cleanup(),LoggerService.instance=null)}initializeAdapters(){if(this.config.enableConsole){const e=new r;e.configure(this.config),this.adapters.set("console",e)}const e=new o;if(e.configure(this.config),this.adapters.set("memory",e),this.config.enableDatabase){const e=new l;e.configure(this.config),this.adapters.set("database",e)}if(this.config.enableFile){const e=new c;e.configure(this.config),this.adapters.set("file",e)}}shouldLog(e){return e>=this.config.level}createLogEntry(e,t,s,i,n){const a={id:this.generateId(),timestamp:new Date,level:e,message:t,context:s,error:i,metadata:n};return this.config.includeStack&&i?.stack&&(a.stack=i.stack),a}generateId(){return function(){if("undefined"!=typeof require)try{const{randomUUID:e}=require("crypto");return e()}catch{}return"undefined"!=typeof globalThis&&globalThis.crypto&&globalThis.crypto.randomUUID?globalThis.crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}()}async log(e){if(!this.shouldLog(e.level))return;const t=[];switch(this.config.strategy){case LogStrategy.CONSOLE:this.adapters.has("console")&&t.push(this.adapters.get("console").log(e));break;case LogStrategy.MEMORY:this.adapters.has("memory")&&t.push(this.adapters.get("memory").log(e));break;case LogStrategy.DATABASE:this.adapters.has("database")&&t.push(this.adapters.get("database").log(e));break;case LogStrategy.FILE:this.adapters.has("file")&&t.push(this.adapters.get("file").log(e));break;case LogStrategy.HYBRID:for(const s of this.adapters.values())t.push(s.log(e))}await Promise.allSettled(t)}debug(e,t,s){const i=this.createLogEntry(LogLevel.DEBUG,e,t,void 0,s);this.log(i)}info(e,t,s){const i=this.createLogEntry(LogLevel.INFO,e,t,void 0,s);this.log(i)}warn(e,t,s){const i=this.createLogEntry(LogLevel.WARN,e,t,void 0,s);this.log(i)}error(e,t,s,i){const n=this.createLogEntry(LogLevel.ERROR,e,s,t,i);this.log(n)}fatal(e,t,s,i){const n=this.createLogEntry(LogLevel.FATAL,e,s,t,i);this.log(n)}async getLogs(e,t){if(e&&this.adapters.has(e)){const s=this.adapters.get(e);if("query"in s)return s.query({limit:t})}if(this.adapters.has("memory")){return this.adapters.get("memory").getLogs(t)}return[]}async getErrorLogs(e){return(await this.getLogs(void 0,e)).filter(e=>e.level>=LogLevel.ERROR)}async clearLogs(e){if(e&&this.adapters.has(e)){const t=this.adapters.get(e);"clear"in t&&await t.clear()}else for(const e of this.adapters.values())"clear"in e&&await e.clear()}getStats(){const e={memory:0,database:0,file:0,errors:0,maxMemory:this.config.maxMemoryEntries||1e3,maxDatabase:this.config.maxDatabaseEntries||1e4,maxFile:this.config.maxFileEntries||5e3};for(const[t,s]of this.adapters)if("getStats"in s){const i=s.getStats();e[t]=i.count||0,i.errors&&(e.errors+=i.errors)}return e}updateConfig(e){this.config={...this.config,...e};for(const e of this.adapters.values())e.configure&&e.configure(this.config)}async cleanup(){for(const e of this.adapters.values())e.cleanup&&await e.cleanup()}}LoggerService.instance=null;class h{constructor(e){this.requestId="",this.logger=e||LoggerService.getInstance()}static getInstance(e){return h.instance||(h.instance=new h(e)),h.instance}static reset(){h.instance=null}setRequestContext(e){this.requestId=e?.headers.get("x-request-id")||this.generateId(),this.appSlug=this.extractAppSlug(e),this.userId=this.extractUserId(e)}generateId(){return g("req")}extractAppSlug(e){if(!e)return;const t=new URL(e.url).pathname.split("/"),s=t.findIndex(e=>"apps"===e)+1;if(s>0&&t[s])return t[s];const i=t.findIndex(e=>"api"===e);return i>0&&t[i+1]&&"admin"!==t[i+1]?t[i+1]:void 0}extractUserId(e){if(!e)return;const t=e.headers.get("authorization");return t?.startsWith("Bearer ")?"user-from-token":void 0}createContext(e){return{requestId:this.requestId,appSlug:this.appSlug,userId:this.userId,...e}}debug(e,t){this.logger.debug(e,this.createContext(t))}info(e,t){this.logger.info(e,this.createContext(t))}warn(e,t){this.logger.warn(e,this.createContext(t))}error(e,t,s){this.logger.error(e,t,this.createContext(s))}fatal(e,t,s){this.logger.fatal(e,t,this.createContext(s))}}const f=h.getInstance();exports.ServerLogger=h,exports.getServerLogger=function(e,t){const s=t?h.getInstance(t):f;return s.setRequestContext(e),s},exports.logApiError=(e,t,s,i,n)=>{const a=n?h.getInstance(n):f;a.setRequestContext(e),a.error(t,s,i)},exports.logApiInfo=(e,t,s,i)=>{const n=i?h.getInstance(i):f;n.setRequestContext(e),n.info(t,s)},exports.logApiWarn=(e,t,s,i)=>{const n=i?h.getInstance(i):f;n.setRequestContext(e),n.warn(t,s)};
//# sourceMappingURL=nextjs.js.map
